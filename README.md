# ğŸ” LLM-Observability-Stack

> LLM æ¨ç†æœåŠ¡å¯è§‚æµ‹æ€§æ–¹æ¡ˆ - ç›‘æ§æŒ‡æ ‡ç›®å½•ä¸æœ€ä½³å®è·µ

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](https://opensource.org/licenses/MIT)
[![Prometheus](https://img.shields.io/badge/Prometheus-orange)](https://prometheus.io/)
[![Grafana](https://img.shields.io/badge/Grafana-F46800?style=flat&logo=grafana&logoColor=white)](https://grafana.com/)

## ğŸ“– é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æä¾›äº†ä¸€å¥—å®Œæ•´çš„ **LLM æ¨ç†æœåŠ¡å¯è§‚æµ‹æ€§è§£å†³æ–¹æ¡ˆ**ï¼ŒåŒ…å«ä¸‰å±‚ç›‘æ§æŒ‡æ ‡ä½“ç³»ï¼Œè¦†ç›– GPU ç¡¬ä»¶å±‚ã€æ¨ç†æœåŠ¡å±‚ã€ä¸šåŠ¡å±‚ã€‚

## ğŸ—ï¸ ç›‘æ§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¯è§‚æµ‹æ€§æ•°æ®é‡‡é›†å±‚                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DCGM Exporter  â”‚  vLLM Metrics  â”‚  Custom Exporter           â”‚
â”‚  (GPU ç¡¬ä»¶)     â”‚  (æ¨ç†æœåŠ¡)      â”‚  (ä¸šåŠ¡æŒ‡æ ‡)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                         â”‚
         â–¼                  â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Prometheus                               â”‚
â”‚                    (æ—¶åºæ•°æ®åº“ + å‘Šè­¦è§„åˆ™)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Grafana                                   â”‚
â”‚                  (å¯è§†åŒ– + å‘Šè­¦é€šçŸ¥)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š ä¸‰å±‚ç›‘æ§æŒ‡æ ‡ä½“ç³»

### ç¬¬ä¸€å±‚ï¼šGPU ç¡¬ä»¶å±‚ï¼ˆDCGM Exporter é‡‡é›†ï¼‰

| æŒ‡æ ‡å | å«ä¹‰ | å•ä½ | å‘Šè­¦é˜ˆå€¼ |
|--------|------|------|----------|
| DCGM_FI_DEV_GPU_UTIL | GPU è®¡ç®—æ ¸å¿ƒåˆ©ç”¨ç‡ | % | >95% |
| DCGM_FI_DEV_FB_USED | å·²ä½¿ç”¨æ˜¾å­˜ | MiB | >90% |
| DCGM_FI_DEV_FB_FREE | å¯ç”¨æ˜¾å­˜ | MiB | <2048 |
| DCGM_FI_DEV_GPU_TEMP | GPU æ¸©åº¦ | â„ƒ | >80â„ƒ |
| DCGM_FI_DEV_POWER_USAGE | GPU åŠŸè€— | W | >140W |

### ç¬¬äºŒå±‚ï¼šæ¨ç†æœåŠ¡å±‚ï¼ˆvLLM åŸç”Ÿ + è‡ªå®šä¹‰ Exporterï¼‰

| æŒ‡æ ‡å | å«ä¹‰ | ç±»å‹ |
|--------|------|------|
| vllm:e2e_request_latency_seconds | ç«¯åˆ°ç«¯è¯·æ±‚å»¶è¿Ÿ | Histogram |
| vllm:num_requests_running | æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•° | Gauge |
| vllm:num_requests_waiting | ç­‰å¾…ä¸­çš„è¯·æ±‚æ•° | Gauge |
| vllm:time_to_first_token_seconds | é¦– Token å»¶è¿Ÿ (TTFT) | Histogram |
| vllm:time_per_output_token_seconds | æ¯è¾“å‡º Token è€—æ—¶ | Histogram |
| vllm:gpu_cache_usage_perc | GPU KV Cache ä½¿ç”¨ç‡ | Gauge |

### ç¬¬ä¸‰å±‚ï¼šä¸šåŠ¡å±‚ï¼ˆPrometheus è§„åˆ™è®¡ç®—ï¼‰

| æŒ‡æ ‡/è§„åˆ™ | å«ä¹‰ | è®¡ç®—æ–¹å¼ |
|-----------|------|---------|
| QPS | æ¯ç§’è¯·æ±‚æ•° | `rate(vllm:request_total[1m])` |
| è¯·æ±‚æˆåŠŸç‡ | æˆåŠŸ/æ€»æ•° | `1 - (error/total)` |
| P50/P95/P99 å»¶è¿Ÿ | å»¶è¿Ÿåˆ†ä½æ•° | `histogram_quantile(0.99, ...)` |
| Token ååé‡ | æ¯ç§’ç”Ÿæˆ Token æ•° | `rate(vllm:generation_tokens_total[1m])` |

## ğŸ“ é¡¹ç›®ç»“æ„

```
llm-observability-stack/
â”œâ”€â”€ docs/                      # æ–‡æ¡£
â”‚   â””â”€â”€ metrics-catalog.md   # æŒ‡æ ‡ç›®å½•
â”‚
â”œâ”€â”€ k8s/                      # K8s é…ç½®
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ grafana/                  # Grafana é…ç½®
â”‚   â”œâ”€â”€ dashboards/          # ç›‘æ§é¢æ¿
â”‚   â””â”€â”€ provisioning/        # è‡ªåŠ¨é…ç½®
â”‚
â”œâ”€â”€ prometheus/              # Prometheus é…ç½®
â”‚   â””â”€â”€ rules/              # å‘Šè­¦è§„åˆ™
â”‚
â”œâ”€â”€ exporters/               # è‡ªå®šä¹‰ Exporter
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ otel/                    # OpenTelemetry
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ alertmanager/            # å‘Šè­¦é€šçŸ¥é…ç½®
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ scripts/                 # è¿ç»´è„šæœ¬
    â””â”€â”€ ...
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. éƒ¨ç½² DCGM Exporter

```bash
kubectl apply -f k8s/dcgm-exporter.yaml
```

### 2. é…ç½® Prometheus å‘Šè­¦è§„åˆ™

```bash
kubectl apply -f prometheus/rules/
```

### 3. å¯¼å…¥ Grafana é¢æ¿

```bash
kubectl apply -f grafana/dashboards/
```

## ğŸ“ˆ é…å¥—é¡¹ç›®

- **æ¨ç†æœåŠ¡éƒ¨ç½²**: [k8s-llm-inference-platform](https://github.com/fuqiangfeng96-web/k8s-llm-inference-platform)
- **ç›‘æ§é¢æ¿**: [k8s-llm-monitor](https://github.com/fuqiangfeng96-web/k8s-llm-monitor)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

---

*å¦‚æœå¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ Star â­*
